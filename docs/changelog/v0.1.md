# OmniForge CLI v0.1.0 Changelog

**Release Date:** January 26, 2025
**Status:** Development Preview

---

## Overview

Initial development release of OmniForge CLI - a command-line tool for installing and managing OMNI infrastructure (hostagent-server) on user systems, with full AWS backend integration for authentication, artifact management, and AI-assisted remediation.

---

## Features Implemented

### Core CLI Framework

- **Go Module Setup**
  - Initialized `github.com/spotlight-omni/spotlight-cli` module
  - Cobra CLI framework for command structure
  - Build system with Makefile supporting cross-platform compilation

- **Command Structure**
  ```
  omniforge
  ├── version      - Show version and platform info
  ├── prereq       - Check/install prerequisites
  ├── install      - Install OMNI infrastructure
  ├── up           - Start OMNI services
  ├── down         - Stop OMNI services
  ├── status       - Show service status
  ├── doctor       - Diagnose and fix issues (online/offline)
  ├── logs         - View service logs
  ├── login        - Authenticate with OmniForge service
  ├── logout       - Clear auth tokens
  ├── bundle       - Manage offline bundles
  └── incident     - Create and upload incident reports
  ```

### Platform Detection (`internal/osdetect`)

- **Supported Platforms**
  - macOS (Darwin) - arm64/amd64
  - Linux - Ubuntu, Debian (apt-based)
  - Windows - Detection only (installation not yet supported)

- **Features**
  - OS and architecture detection
  - Linux distribution identification via `/etc/os-release`
  - Package manager detection (brew, apt, dnf, pacman, winget)
  - Platform support validation

### Configuration Management (`internal/config`)

- **Config Storage**
  - JSON configuration at `~/.omniforge/config.json`
  - Automatic directory creation for logs, cache, incidents
  - Default values for server URL and install paths

- **Authentication State**
  - JWT token storage (access + refresh tokens)
  - Token expiration tracking
  - Secure credential clearing on logout

### AWS Backend Integration

- **API Gateway + Lambda Architecture**
  - RESTful API at `https://k8a1kkxw4h.execute-api.us-east-1.amazonaws.com/v1`
  - JWT-based authentication
  - RDS PostgreSQL database

- **Endpoints Implemented**
  | Endpoint | Method | Purpose |
  |----------|--------|---------|
  | `/v1/auth/login` | POST | User authentication |
  | `/v1/auth/refresh` | POST | Token refresh |
  | `/v1/allowlist` | GET | Tool allowlist |
  | `/v1/plan` | POST | AI remediation planning |
  | `/v1/step_result` | POST | Step execution logging |
  | `/v1/incidents` | GET/POST | Incident management |
  | `/v1/artifacts/manifest` | GET | Artifact manifest |

- **OpenAI Integration**
  - GPT-4o mini for remediation plan generation
  - Structured JSON plan output
  - Tool allowlist enforcement

### Tool Registry (`internal/tools`)

- **Built-in Tools (12)**
  | Tool | Purpose | Dangerous |
  |------|---------|-----------|
  | health_check | Comprehensive health checks | No |
  | check_docker | Docker daemon status | No |
  | check_compose | Docker Compose availability | No |
  | check_python | Python 3.9+ installed | No |
  | check_git | Git installed | No |
  | check_ports | Port availability | No |
  | check_network | Network connectivity | No |
  | check_disk_space | Disk space check | No |
  | check_memory | Memory availability | No |
  | restart_docker | Restart Docker service | Yes |
  | restart_service | Restart specific service | Yes |
  | view_logs | View service logs | No |

- **Features**
  - Server-side allowlist enforcement
  - Dangerous tool confirmation
  - JSON schema argument validation

### Doctor Loop (`internal/doctor`)

- **Online Mode**
  - Fetches tool allowlist from server
  - Requests AI-generated remediation plans
  - Executes plan steps with progress tracking
  - Reports step results to server
  - Iterates until health checks pass

- **Offline Mode**
  - Deterministic remediation ladder
  - No server connectivity required
  - 8-step remediation sequence

### Incident Reporting (`internal/bundle`)

- **Incident Bundle Creation**
  - System info collection
  - Health check results
  - Log collection with secret redaction
  - ZIP archive creation

- **Server Upload**
  - Presigned S3 URL for secure upload
  - Incident metadata storage in RDS

### Privilege Elevation (`internal/elevate`)

- **Root/Admin Handling**
  - Detection of root/admin privileges
  - Sudo re-execution for Unix systems
  - Error messaging for insufficient privileges

### Command Execution (`internal/exec`)

- **Safe Execution**
  - Context-aware command runner with timeouts
  - Output capture (stdout/stderr) with size limits
  - Exit code handling and error reporting
  - Tail utilities for log snippets

### Prerequisite System (`internal/prereq`)

- **Implemented Prerequisites**
  | Prereq | Check | Install (macOS) | Install (Ubuntu) |
  |--------|-------|-----------------|------------------|
  | Docker | ✓ | ✓ (brew cask) | ✓ (apt) |
  | Docker Compose | ✓ | ✓ (bundled) | ✓ (plugin) |
  | Python 3.9+ | ✓ | ✓ (brew) | ✓ (apt) |
  | Git | ✓ | ✓ (brew/xcode) | ✓ (apt) |
  | Ports (4443, 8443, 8998) | ✓ | N/A | N/A |

### OMNI Management (`internal/omni`)

- **Installation**
  - Tarball extraction to `/opt/hostagent-server/`
  - Docker image loading from embedded tar files
  - Script permission setup
  - Installation verification

- **Lifecycle Management**
  - Service start via `start.sh` or docker-compose
  - Service stop with optional volume removal
  - Service restart capability
  - Log viewing with follow mode

- **Health Checks**
  - Docker daemon connectivity
  - PostgreSQL container health
  - Keycloak HTTPS endpoint + OMNI realm
  - Host Agent Server port (8998)
  - OMNI Gateway port (8443)

---

## AWS Infrastructure

### Resources Created

| Resource | Name | Purpose |
|----------|------|---------|
| VPC | omniforge-vpc | Network isolation |
| RDS | omniforge-db | PostgreSQL database |
| S3 | omniforge-artifacts-* | Artifact storage |
| S3 | omniforge-incidents-* | Incident storage |
| Lambda (7) | omniforge-* | API handlers |
| API Gateway | omniforge-api | REST API |
| Secrets Manager | omniforge/* | Credentials |

### Database Schema

- `users` - Authentication
- `allowlist` - Tool permissions
- `incidents` - Incident reports
- `runs` - Remediation runs
- `step_results` - Step execution logs

---

## Project Structure

```
spotlight-omni-cli/
├── go.mod
├── go.sum
├── Makefile
├── omniforge                       # Built binary
│
├── assets/
│   ├── hostagent-server/
│   │   └── hostagent-server.tar.gz
│   └── hostagent-client/
│       ├── hostagent.darwin
│       ├── hostagent.linux
│       └── ...
│
├── cmd/spotlight/
│   ├── main.go
│   └── commands/
│       └── root.go
│
├── internal/
│   ├── api/                        # API client
│   │   ├── client.go
│   │   ├── auth.go
│   │   ├── allowlist.go
│   │   ├── plan.go
│   │   ├── artifacts.go
│   │   └── incidents.go
│   ├── config/
│   │   └── config.go
│   ├── osdetect/
│   │   ├── osdetect.go
│   │   ├── darwin.go
│   │   ├── linux.go
│   │   └── windows.go
│   ├── elevate/
│   │   └── elevate.go
│   ├── exec/
│   │   └── runner.go
│   ├── prereq/
│   │   ├── prereq.go
│   │   ├── docker.go
│   │   ├── python.go
│   │   ├── git.go
│   │   └── ports.go
│   ├── omni/
│   │   ├── omni.go
│   │   ├── install.go
│   │   ├── lifecycle.go
│   │   └── health.go
│   ├── tools/
│   │   └── registry.go
│   ├── doctor/
│   │   ├── doctor.go
│   │   └── ladder.go
│   ├── bundle/
│   │   └── incident.go
│   └── redact/
│       └── redact.go
│
├── server/
│   ├── go.mod
│   ├── Makefile
│   ├── cmd/lambda/
│   │   ├── auth/main.go
│   │   ├── allowlist/main.go
│   │   ├── plan/main.go
│   │   ├── step/main.go
│   │   ├── artifacts/main.go
│   │   ├── incidents/main.go
│   │   └── migrate/main.go
│   └── internal/
│       ├── db/
│       ├── auth/
│       ├── openai/
│       ├── storage/
│       └── artifacts/
│
└── docs/
    └── changelog/
        └── v0.1.md
```

---

## Dependencies

### CLI
| Package | Version | Purpose |
|---------|---------|---------|
| github.com/spf13/cobra | v1.10.2 | CLI framework |
| golang.org/x/crypto | latest | bcrypt password hashing |
| golang.org/x/term | latest | Terminal password input |

### Server
| Package | Purpose |
|---------|---------|
| github.com/aws/aws-lambda-go | Lambda runtime |
| github.com/aws/aws-sdk-go-v2 | AWS SDK |
| github.com/golang-jwt/jwt/v5 | JWT tokens |
| github.com/lib/pq | PostgreSQL driver |
| github.com/sashabaranov/go-openai | OpenAI client |
| github.com/google/uuid | UUID generation |
| golang.org/x/crypto | Password hashing |

---

## Build Commands

```bash
# Build CLI for current platform
make build

# Build with version info
make build VERSION=v0.1.0

# Build for all platforms
make build-all

# Run tests
make test

# Clean build artifacts
make clean
```

---

## Usage Examples

```bash
# Check version and platform
./omniforge version

# Check prerequisites
./omniforge prereq

# Install missing prerequisites (requires sudo)
sudo ./omniforge prereq --install

# Login to OmniForge service
./omniforge login

# Install OMNI from local tarball
sudo ./omniforge install --tarball assets/hostagent-server/hostagent-server.tar.gz

# Check service status
./omniforge status

# Start services
./omniforge up

# Stop services
./omniforge down

# View logs
./omniforge logs
./omniforge logs -f              # Follow mode
./omniforge logs keycloak -n 50  # Specific service

# Run diagnostics (online mode - uses AI)
./omniforge doctor

# Run diagnostics (offline mode - deterministic)
./omniforge doctor --offline

# Create incident report
./omniforge incident create --summary "Services not starting"

# Upload existing incident
./omniforge incident upload ./incident-20250126-123456.zip
```

---

## Default Credentials

| Username | Password |
|----------|----------|
| admin | admin123 |

---

## Known Limitations

### Not Yet Implemented

1. **Platform Support**
   - Windows installation not implemented
   - RHEL/Fedora/Arch Linux installers not implemented

2. **Artifact Download**
   - GitHub release fetching requires NAT gateway for VPC Lambda

### Known Issues

- Health checks may show false negatives if containers exist but aren't from OMNI
- Port checks happen at CLI start, may conflict with services starting later
- No automatic Docker Desktop startup on macOS

---

## Next Steps (v0.2.0)

1. Add Windows platform support
2. Add RHEL/Fedora Linux support
3. Implement artifact caching
4. Add NAT gateway for Lambda GitHub access
5. Implement offline bundle creation

---

## License

Proprietary - OmniForge Security Framework
